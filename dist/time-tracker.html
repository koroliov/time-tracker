<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>time-tracker</title>
  <meta name="description" content="track time">
  <meta name="author" content="d.koroliov@gmail.com">
  <!--<meta http-equiv="refresh" content="2">-->
  <link id="favicon" href="data:image/x-icon;base64," rel="icon"
    type="image/x-icon">
  <!--<link id="favicon" href="../local-ignore/red.png" rel="icon"
    type="image/x-icon">-->
  <style>
    body {
      font-family: sans-serif;
    }
  </style>
</head>
<body>
  <template id="time-tracker">
    <style>
      #time-tracker {
        --base-font-size: 16px;
        --main-bg-color: white;
        font-size: calc(var(--base-font-size) * 0.9);
        line-height: calc(var(--base-font-size) * 1.1);
        max-width: 1200px;
        margin: 0 auto;
        border: 1px solid black;
        padding: 0 0 0 calc(var(--base-font-size) * 0.5);
      }

      #time-tracker > .grid-wrapper {
        display: grid;
        --grid-columns: 4;
        grid-template-rows: 0.8fr;
        grid-template-columns: repeat(var(--grid-columns), 1fr);
      }
      h1 {
        font-size: calc(var(--base-font-size) * 1.2);
        line-height: calc(var(--base-font-size) * 0.5);
        text-align: center;
      }
      h1 div {
        font-size: calc(var(--base-font-size) * 1.1);
        font-weight: normal;
        margin-top: calc(var(--base-font-size));
      }
      h1 span {
        margin: 0 calc(var(--base-font-size));
      }
      h1 .version {
        font-size: calc(var(--base-font-size) * 0.9);
        margin: 0;
        font-weight: normal;
      }

      .caption {
        font-size: calc(var(--base-font-size) * 1.1);
        grid-column: 1;
      }
      .value {
        grid-column: 2;
      }
      .percent-current {
        grid-column: 3;
      }
      .percent-target {
        grid-column: 4;
      }

      .head {
        font-size: calc(var(--base-font-size) * 1.1);
      }

      #time-tracker > .grid-wrapper > .controls {
        grid-column: 1 / calc(var(--grid-columns) + 1);
        margin-bottom: calc(var(--base-font-size) * 0.2);
      }
      #time-tracker > .controls > a {
        margin-left: 1ex;
      }
      #time-tracker > .controls > a:first-child {
        margin-left: 0;
      }
      .controls a {
        margin-right: var(--base-font-size);
      }
      #message,
      .controls input,
      .controls .export-link {
        display: none;
      }
      #message {
        position: fixed;
        top: 2vh;
        left: 0;
        right: 0;
        margin: 0 auto;
        width: calc(var(--main-max-width) * 0.8);
        min-height: calc(80vh);
      }
      .children {
        grid-column: 1 / calc(var(--grid-columns) + 1);
      }
      /* children */

      time-entry {
        border: solid 1px black;
        border-right: none;
        padding-left: calc(var(--base-font-size) * 0.5);
        display: grid;
        --grid-columns: 4;
        grid-template-columns: 5fr repeat(3, calc(var(--base-font-size) * 6));
        column-gap: calc(var(--base-font-size) * 1);
      }
      .white-black > .children > time-entry:nth-child(even),
      .black-white > .children > time-entry:nth-child(odd) {
        background-color: #ebebeb;
      }
      .white-black > .children > time-entry:nth-child(odd),
      .black-white > .children > time-entry:nth-child(even) {
        background-color: var(--main-bg-color);
      }
      time-entry.is-active {
        background-color: #e0ffe9 !important;
      }
      /* I don't know a better way to do it in CSS */
      time-entry > div:nth-child(1),
      time-entry > div:nth-child(2),
      time-entry > div:nth-child(3),
      time-entry > div:nth-child(4) {
        font-weight: bold;
      }
      time-entry > .controls {
        grid-column: 1/2;
        grid-row: 4;
      }
    </style>

    <div id="time-tracker">
      <h1>Time Tracker <span class="version"></span>
        <div>
          <span>target</span>
          <span>total:</span>
          <span contenteditable="true" class="abs-target"></span>
          <span>billable:</span>
          <span contenteditable="true" class="percent-target"></span>
        </div>
      </h1>
      <div class="grid-wrapper black-white">
        <div class="head caption">Time spent</div>
        <div class="head value">value</div>
        <div class="head percent-current">current</div>
        <div class="head percent-targed">target</div>

        <div class="total caption">Total:</div>
        <div class="total value">—</div>
        <div class="total percent-current">—</div>
        <div class="total percent-target">—</div>

        <div class="billable caption">Billable:</div>
        <div class="billable value">—</div>
        <div class="billable percent-current">— %</div>
        <div class="billable percent-target">— %</div>

        <div class="controls">
          <a href="#" class="clear">Clear</a>
          <a href="#" class="new-entry">New Entry</a>
          <a href="#" class="import">Import</a>
          <input type="file" class="import-input">
          <a href="#" class="export">Export</a>
          <a href="#" class="export-link"></a>
          <a href="#" class="collapse-open">Collapse (0)</a>
        </div>
        <div class="children"></div>
      </div>
      <textarea id="message"></textarea>
    </div>
  </template>
  <template id="time-entry">
    <div>
      <div class="title" contenteditable="true"></div>
    </div>
    <div class="time-spent-title">time spent</div>
    <div class="time-spent-value">value</div>
    <div class="time-spent-percent">percent</div>

    <div>
      <div class="comment" contenteditable="true"></div>
    </div>
    <div class="total-title">Total:</div>
    <div class="total-value">—</div>
    <div class="total-percent">—</div>

    <label class="is-own-time-billable">
      Is own time billable: <input type="checkbox">
    </label>
    <div class="own-title">Own:</div>
    <div class="own-value">
      <div contenteditable="true">—</div>
    </div>
    <div class="own-percent">—</div>

    <div class="billable-title">Billable:</div>
    <div class="billable-value">—</div>
    <div class="billable-percent">— %</div>

    <div class="controls">
      <a href="#" class="start-stop">Start</a>
      <a href="#" class="new-entry">New Entry</a>
      <a href="#" class="collapse-open">Collapse (0)</a>
      <a href="#" class="generate-message">Generate message</a>
    </div>

    <div class="children"></div>
  </template>
  <template id="grey-circle">data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAACXBIWXMAAAsTAAALEwEAmpwYAAACBklEQVRIx8WXwWoTURSGv3OTFsyiG1GIC3EtUsRSuixiN0WooBafYUaro4jv0IUQmubclYjLQJfahUihtAuFKqm+gXFRWqwgtYFYc1x0UkhTmiFNJv92LvPx3zlzzn+EhAqiICcHMoUxCoxhnANA+AN8Qdi0rK34gt9P8j7pdCCcCyZoSIQxA+Q6HN9DeAvMa0krXYGDKLgkdSkAs3QjoYwj0qJuJQaHD8NbGGXgPGeRsAPc1ZKuH3/k2pw+CR5gLJ8ZCmBcwHgfPg5un+o4droMDNNb1cjYtBb9ahs4/qZfe+L0ZG0DV1X1Z8tVx4XULyjAReBli+NwLpjgn3yk/2rguKGLunnouCER6chhPAOQIApyUpedBM2hV/ptw5Z3ciBTKUIBRuSvjLu496atSQeMDQCcd0dTJl1dcQxGDYdQGwD4uwM+DwBcdQiVAYDXnGVtBdhLEbprQ7bhfMHvx3ElHQlLvuBrzaqeByylIbF4NBa1pBWEcgrg11rUb63Rx/EUYbuP0B+WtRdtmStOg/egL/91DeG+X/C7J4Y9Lek6WZvtMbwGzGhJP52aMnXBvyNj0whbPajgKsJNVf3QMd4eXrtfBa4Bb4BGV9ULryxj1487Tb7CPApHMZ5j3AFGOhz/hbCEo9is3q53p5alrS7jCJNAHrjcbPhAFVizIdvwBZ+oPv4DrvCs3jt9gZMAAAAASUVORK5CYII=</template>
  <template id="green-circle">data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAACXBIWXMAAAsTAAALEwEAmpwYAAACV0lEQVRIx8WX30uTYRTHv9/zrKm78CYK5kV0HSGRiJcSuc1NcJqt/g2L6H/wIhDqNqJLh7p3YPtlCKIXBRZa/0F2IUoGYc717n1OF7pgWW7M7fV7+z68X86Xz3POeYgmlconQ26gMqK0/QAGFOgBAAI/ofhIla1gtWslncgeNvM/NjowWYoPWbHTSjsOINTg+AFVlmg540QLmy0ZT5XG+lxxZ0FNoQVRZc54Znoxlttp2nhiefSuFTsH6GWcQ1TuUXnPiRTX//4mp6Jdjj+04uXOawoASr1ixZYmlkfHzqz4uFIvByCI9qpsvEA8E82vnjKeKo71VY37SXn+Sv8T+y493nBixW91UVeNO9sp05PYr6rRZ3UVT5biQ56pvkPnZU3V3M7EClsCAFa8afgjsUYfAwBT+WSoEjzca6I5tCvzH92/esLimqMR30yPKeutXDoaFBXth88iMCwABvw2VmpYalPGZ10XXIysEChfgPEXAfDBd7iU20Llpu9wAWsSdLtXoDjwEen9LrdnQ9KJ7CGVSz7e4fl0winLyZoyc5yADzRb8+LPWHSihU2qzPkA1atMNP+5bh4bzzyicreDRH0NeMGnp3auxVhuhypT6My9LouV+wuxpf1/LntOpLAu1qTabF6m5bgTLb4/c8t0IoU3xgvEqdxpS6OwcicbKb1tuN4CQCaaX4XlTSpfA7Ct0Evly4AXvOVE6itt+gkzURrtV9EnCk2C2tsAoO8E58Wa5zV6W3471fQgnwxVTHmQ5LBSwwCu1Ro+ldsKrHW53RvpRLYpPn4DeCPyNirucBcAAAAASUVORK5CYII=</template>
  <template id="red-circle">data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAACXBIWXMAAAsTAAALEwEAmpwYAAACaUlEQVRIx8WXz0sUYRyHP+87P96dd8bV3XExK4RueQr8A6IgqCDwEHbr5CHItALL/6BDh2QRhSIIIvQgBNa9gwTeootQCBGRRabirvvuzDv7zrwdKtFKm3R3eo5zeJ95vz+GzxCkQHLuxUX3FA2ifhI0ejUz+4hUDgAkbUwQGb9OuLVIRTRHVDLPhKj97Uyyp9DhvvLdUaMmB0mkSmleUtvmVxKpSRAywYRY/2dx0F28TCvhOAAf+2M18ZzrzsradCpxZDJb28YUgEE0gcSzJ6nUI6xSSbY/pzukhNnyWOdss6QAQGvRkCrmnigQuuuNJecPmynd0fucNZVbrwz9Jv7R08doLZdYvT67JZYO90Hw9gCDlJbPIOQ4E6JKAUD57mgGUgDoThz7JgAQybmnbfNd2j09cK9tc+XplbNHSP1o6YKxLp4jQ+I8P09pEPUjY4xq/TQlQaM3a7HOmSepZmZf1mIQ0kkk5xrZoyn+h5WZMdXMDDI3U/KeEqleZd7ioPGFxh3OYtbipI3NUyqiucwrvSlfEOm6nraM7D6ZOfMjjWkPZULUSKQmM5toy3hgVza+r1P1RE8ZwGoG3g+0FpW3ok9p4c1G3OGMtPqycYEPMyGqOzIX/7Q2k3h2K0s+zpdXn/0x7FGpR1RX20wLpI9gWbf2jLcKhKpifoKEjavNKC+Ae7Cs27/G210Dff2wf9HYCCYAdO93kOICH95e3vS/MK6bTzz7Bt2U1wCUUu7psraM+7QWlX8O0r6ZHhsw64c6z0nO74bF/ELoty+FhbwKC/lG6LcvSc5fBl2FO9LhZ6bHBsw0Z34D4P7rWA2kfEUAAAAASUVORK5CYII=</template>
  <script>
    'use strict';
    (function() {
      //Base class
      class Base extends HTMLElement {
        constructor() {
          super();
        }

        addListeners(node) {
          node.querySelector('.controls .new-entry')
            .addEventListener('click', this.addNewTimeEntry.bind(this));
          node.querySelector('.controls .collapse-open')
            .addEventListener('click', this.toggleChildEntriesVisible.bind(this));
          node.addEventListener('activate', this.handleActivateEvent.bind(this));
          node.addEventListener('active-entry-changed',
            this.handleEntryActiveChangedEvent.bind(this));
          node.addEventListener('disactivate',
            this.handleDisactivateEvent.bind(this));
          node.addEventListener('is-billable-changed',
            this.handleIsBillableChanged.bind(this));
        }

        handleIsBillableChanged(e) {
          if (e.target === this.activeChildOrSelf) {
            this.isCountBillable = e.detail.isBillable;
          }
          this.timeSpentBillable += e.detail.billableTimeChange;
          this.updateTimeText();
        }

        handleActivateEvent(e) {
          if (e.target === this) {
            this.handleWhenActiveItself();
          }
          this.isCountBillable = e.detail.isBillable;
          if (this.activeChildOrSelf) {
            if (this.activeChildOrSelf !== this) {
              this.fireDisactivateEventToCurrentlyActiveEntry();
            }
            this.fireActiveEntryChangedEvent(e.target);
            e.stopPropagation();
          }
          this.activeChildOrSelf = e.target;
          this.stopCount();
          this.startCount();
        }

        fireActiveEntryChangedEvent(newActiveEntry) {
          const entryActiveChangedEvent = new CustomEvent('active-entry-changed', {
            detail: { activeEntry: newActiveEntry, },
            bubbles: true,
          });
          this.dispatchEvent(entryActiveChangedEvent);
        }

        fireDisactivateEventToCurrentlyActiveEntry() {
          const disactivateEvent = new CustomEvent('disactivate', {
            detail: { firedFrom: this, },
            bubbles: true,
          });
          this.activeChildOrSelf.dispatchEvent(disactivateEvent);
        }

        handleWhenInactiveItself() {
          this.querySelector('.start-stop').innerText = 'Start';
          this.classList.remove('is-active');
        }

        handleEntryActiveChangedEvent(e) {
          if (this.activeChildOrSelf === this) {
            this.handleWhenInactiveItself();
          }
          this.isCountBillable = e.detail.activeEntry.isOwnTimeBillable;
          this.activeChildOrSelf = e.detail.activeEntry;
        }

        disactivate(evTarget) {
          if (evTarget === this) {
            this.handleWhenInactiveItself();
          }
          this.activeChildOrSelf = null;
          this.isCountBillable = false;
          this.stopCount();
        }

        handleDisactivateEvent(e) {
          if (e.detail.firedFrom === this) {
            if (this.activeChildOrSelf) {
              e.stopPropagation();
            }
          } else {
            this.disactivate(e.target);
          }
        }

        toggleChildEntriesVisible(e) {
          e.preventDefault();
          e.stopPropagation();
          this.isCollapsed = !this.isCollapsed;
          this.handleChildEntriesVisibility();
        }

        initChildEntries(childEntries = [], node) {
          //This will be a recursive call, but it's acceptable, since no huge data
          //structures are expected
          this.childEntries = childEntries.reduce((a, c) => {
            const te = new TimeEntry(c);
            node.querySelector('.children').appendChild(te);
            return a.push(te), a;
          }, []);
          this.setCollapseOpenLink(node);
        }

        addNewTimeEntry(e, node) {
          e.preventDefault();
          e.stopPropagation();
          const te = new TimeEntry(Object.create(null));
          this.childEntries.push(te);
          this.isCollapsed = false;
          addWhiteBlackClass(this);
          this.handleChildEntriesVisibility();
          this.setCollapseOpenLink(node);
          node.querySelector('.children').appendChild(te);

          function addWhiteBlackClass(that) {
            if (isTimeTracker() || node.classList.contains('black-white')) {
              addClass('black-white', 'white-black');
            } else {
              addClass('white-black', 'black-white');
            }

            function addClass(classEven, classOdd) {
              if (nextChildIsOdd()) {
                te.classList.add(classOdd);
                te.classesToPreserve.push(classOdd);
              } else {
                te.classList.add(classEven);
                te.classesToPreserve.push(classEven);
              }
            }

            function isTimeTracker() {
              return !node.classList;
            }

            function nextChildIsOdd() {
              return that.childEntries.length % 2;
            }
          }
        }

        setCollapseOpenLink(node) {
          const collapseOpenLink = node.querySelector('.controls .collapse-open');
          if (this.isCollapsed) {
            collapseOpenLink.innerText = `Open (${this.childEntries.length})`;
          } else {
            collapseOpenLink.innerText = `Collapse (${this.childEntries.length})`;
          }
        }

        handleChildEntriesVisibility(node) {
          const collapseOpenLink = node.querySelector('.controls .collapse-open');
          const childEntriesWrapper = node.querySelector('.children');
          if (this.isCollapsed) {
            collapseOpenLink.innerText = `Open (${this.childEntries.length})`;
            childEntriesWrapper.style.display = 'none';
          } else {
            collapseOpenLink.innerText = `Collapse (${this.childEntries.length})`;
            childEntriesWrapper.style.display = 'block';
          }
        }

        initData(data) {
          this.countUpdatedAt = data?.countUpdatedAt || 0;
          this.timeSpentTotal = data?.timeSpentTotal || 0;
          this.timeSpentBillable = data?.timeSpentBillable || 0;
          this.intervalId = 0;
          this.isCountBillable = data?.isCountBillable || false;

          this.isCollapsed = data?.isCollapsed || false;
          this.childEntries = [];
          this.activeChildOrSelf = null;
        }

        stopCount() {
          clearInterval(this.intervalId);
          this.intervalId = 0;
        }

        startCount() {
          this.countUpdatedAt = Date.now();
          this.intervalId = setInterval(this.updateTime.bind(this), 1000);
        }

        updateTime() {
          const now = Date.now();
          const timeSpentCurrent = now - this.countUpdatedAt;
          this.countUpdatedAt = now;
          if (this.activeChildOrSelf === this) {
            this.timeSpentOwn += timeSpentCurrent;
          }
          if (this.isCountBillable) {
            this.timeSpentBillable += timeSpentCurrent;
          }
          this.timeSpentTotal += timeSpentCurrent;

          this.updateTimeText();
        }

        convertTimeToText(ms) {
          const sec = Math.floor(ms / 1000);
          const secRemainder = sec % 60;
          const min = (sec - secRemainder) / 60;
          const minRemainder = min % 60;
          const hrs = (min - minRemainder) / 60;
          const hrsRemainder = hrs % 8;
          const days = (hrs - hrsRemainder) / 8;
          return `${days}d ${hrsRemainder}h ${minRemainder}m ${secRemainder}s`;
        }
      }

      //Time Tracker class
      class TimeTracker extends Base {
        constructor(data) {
          data.templateId = 'time-tracker';
          super();
          this.initData(data);
          this.initSelfDom(data.templateId, data.childEntries);
          this.initChildEntries(data.childEntries, this.shadowRoot);
          this.addListeners();
          this.setFaviconData();
          this.favIconData.favIcon
            .setAttribute('href', this.favIconData.inactiveHref);
        }

        destroy() {
          if (this.activeChildOrSelf) {
            const disactivateEvent = new CustomEvent('disactivate', {
              detail: { firedFrom: this, },
              bubbles: true,
            });
            this.activeChildOrSelf.dispatchEvent(disactivateEvent);
          }
          this.remove();
        }

        handleIsBillableChanged(e) {
          super.handleIsBillableChanged(e);
          if (this.activeChildOrSelf) {
            this.setBillableFavicon();
          }
        }

        setBillableFavicon() {
          const fi = this.isCountBillable ? this.favIconData.activeBillableHref :
            this.favIconData.activeNotBillableHref;
          this.favIconData.favIcon
            .setAttribute('href', fi);
        }

        handleEntryActiveChangedEvent(e) {
          super.handleEntryActiveChangedEvent(e);
          this.setBillableFavicon();
        }

        toString() {
          return JSON.stringify(this, (key, val) => {
            if (key === 'activeChildOrSelf') {
              return null;
            } else if (key === 'favIconData') {
              return null;
            } else {
              return val;
            }
          });
        }

        initData(data) {
          super.initData(data);
          this.version = data.version;
          this.percentBillableTargetDefault = 75;
          this.percentBillableTarget = data?.percentBillableTarget ||
            this.percentBillableTargetDefault;
          this.timeTotalTargetDefault =  5 * 8 * 3600000;
          this.timeTotalTarget = data?.timeTotalTarget ||
            this.timeTotalTargetDefault;
          this.dateCreated = data?.dateCreated ||
            new Date().toDateString().toLowerCase().replace(/\s+/g, '-');
        }

        addListeners() {
          super.addListeners(this.shadowRoot);
          this.shadowRoot.querySelector('.clear')
            .addEventListener('click', this.clear.bind(this));
          this.shadowRoot.querySelector('.percent-target')
            .addEventListener('blur', this.handleTargetPercentChange.bind(this));
          this.shadowRoot.querySelector('.abs-target')
            .addEventListener('blur', this.handleTargetValueChange.bind(this));
          this.shadowRoot.querySelector('.import')
            .addEventListener('click', this.initiateImport.bind(this));
          this.shadowRoot.querySelector('.import-input')
            .addEventListener('input', this.handleImport.bind(this));
          this.shadowRoot.querySelector('.export')
            .addEventListener('click', this.handleExport.bind(this));
          this.shadowRoot.querySelector('#time-tracker')
            .addEventListener('showmessage', this.showMessageHander.bind(this));
          this.shadowRoot.querySelector('#message')
            .addEventListener('blur', this.hideMessageHander.bind(this));
        }

        async hideMessageHander(e) {
          e.stopPropagation();
          e.target.style.display = 'none';
          e.target.value = '';
        }

        async showMessageHander(e) {
          e.stopPropagation();
          const textArea = this.shadowRoot.querySelector('#message');
          textArea.value = e.detail.message;
          textArea.style.display = 'block';
          textArea.focus();
          textArea.select();
        }

        async handleExport(e) {
          e.preventDefault();
          e.stopPropagation();
          const json = this.toString();
          const l = this.shadowRoot.querySelector('.export-link');
          l.download = `time-tracker-${this.dateCreated}.json`;
          const blob = new Blob([json], {type: 'text/json',});
          l.href = window.URL.createObjectURL(blob);
          l.click();
        }

        async handleImport(e) {
          e.preventDefault();
          e.stopPropagation();
          const json = await e.target.files[0].text();
          e.target.value = '';
          init(json);
        }

        initiateImport(e) {
          e.preventDefault();
          e.stopPropagation();
          const message = [
            'You are about to import a previously exported JSON file',
            'Have you exported a backup copy?',
            'In case of success, your current data will get overwritten and lost.',
            'In case of an error, your current data may get lost',
          ].join('\n');
          if (!window.confirm(message)) {
            return;
          }
          this.shadowRoot.querySelector('.import-input').click();
        }

        handleTargetValueChange(e) {
          const r = /^(\d{1,}d)\s(\d{1}h)\s(\d{1,2}m)\s(\d{1,2}s)$/;
          const match = e.target.innerText.match(r);
          let isValid = true;
          if (!match) {
            alert('Invalid value, format must be Nd (0-7)h (0-59)m (0-59)s');
          } else {
            const d = parseInt(match[1]);
            const h = parseInt(match[2]);
            if (h > 7) {
              alert('Invalid value, hours must be in range [0-7]');
              isValid = false;
            }
            const m = parseInt(match[3]);
            if (m > 59) {
              alert('Invalid value, minutes must be in range [0-59]');
              isValid = false;
            }
            const s = parseInt(match[4]);
            if (s > 59) {
              alert('Invalid value, seconds must be in range [0-59]');
              isValid = false;
            }
            if (isValid) {
              const value = (((d * 8 + h) * 60 + m) * 60 + s) * 1000;
              this.timeTotalTarget = value;
            }
          }
          this.updateTargetText();
          this.updateTimeText();
        }

        handleTargetPercentChange(e) {
          const match = e.target.innerText.match(/^(1?\d{1,2})\s*%$/);
          if (!match) {
            alert('Invalid value, format must be 0-100%');
          } else {
            const percent = Number(match[1]);
            if (percent >= 0 && percent <= 100) {
              this.percentBillableTarget = percent;
            } else {
              alert('Invalid value, format must be 0-100%');
            }
          }
          this.updateTargetText();
          this.updateTimeText();
        }

        clear(e) {
          e.preventDefault();
          e.stopPropagation();
          if (!window.confirm('Are you sure?')) {
            return;
          }
          this.timeSpentTotal = 0;
          this.timeSpentBillable = 0;
          this.timeTotalTarget = this.timeTotalTargetDefault;
          this.percentBillableTarget = this.percentBillableTargetDefault;
          this.childEntries = [];
          this.shadowRoot.querySelector('.children').innerHTML = '';
          this.setCollapseOpenLink(this.shadowRoot);
          this.stopCount();
          this.updateTargetText();
          this.updateTimeText();
        }

        handleChildEntriesVisibility() {
          super.handleChildEntriesVisibility(this.shadowRoot);
        }

        addNewTimeEntry(e) {
          super.addNewTimeEntry(e, this.shadowRoot);
        }

        initSelfDom(templateId) {
          this.attachShadow({mode: 'open',});
          const templateContent = document.querySelector(`#${templateId}`).content;
          const clone = templateContent.cloneNode(true);
          this.shadowRoot.appendChild(clone);
          this.handleChildEntriesVisibility();
          this.updateTargetText();
          this.updateTimeText();
          showVersionNumer(this);

          function showVersionNumer(that) {
            const el = that.shadowRoot.querySelector('h1 .version');
            el.innerText = `v. ${that.version.join('.')}`;
          }
        }

        updateTargetText() {
          this.shadowRoot.querySelector('.abs-target').innerText =
            this.convertTimeToText(this.timeTotalTarget);
          this.shadowRoot.querySelector('.percent-target').innerText =
            this.percentBillableTarget + '%';
        }

        updateTimeText() {
          this.shadowRoot.querySelector('.total.value').innerText =
            this.convertTimeToText(this.timeSpentTotal);
          this.shadowRoot.querySelector('.billable.value').innerText =
            this.convertTimeToText(this.timeSpentBillable);
          const percentCurrent = this.timeSpentTotal ?
            Math.floor(this.timeSpentBillable / this.timeSpentTotal * 100) : 0;
          this.shadowRoot.querySelector('.billable.percent-current').innerText =
            `${percentCurrent}%`;
          const percentTarget =
            calculatePercentTotalBillableSpentToTotalBillableTarget(this);
          this.shadowRoot.querySelector('.billable.percent-target').innerText =
            `${percentTarget}%`;

          function calculatePercentTotalBillableSpentToTotalBillableTarget(that) {
            if (!that.percentBillableTarget || !that.timeTotalTarget) {
              return 0;
            }
            return Math.floor((that.timeSpentBillable /
              (that.percentBillableTarget / 100 * that.timeTotalTarget)) * 100
            );
          }
        }

        handleActivateEvent(e) {
          super.handleActivateEvent(e);
          if (this.isCountBillable) {
            this.favIconData.favIcon
              .setAttribute('href', this.favIconData.activeBillableHref);
          } else {
            this.favIconData.favIcon
              .setAttribute('href', this.favIconData.activeNotBillableHref);
          }
        }

        handleDisactivateEvent(e) {
          super.handleDisactivateEvent(e);
          this.favIconData.favIcon
            .setAttribute('href', this.favIconData.inactiveHref);
        }

        setFaviconData() {
          const o = Object.create(null);
          o.activeBillableHref = document.querySelector('#green-circle').innerHTML;
          o.activeNotBillableHref = document.querySelector('#red-circle').innerHTML;
          o.inactiveHref = document.querySelector('#grey-circle').innerHTML;
          o.favIcon = document.querySelector('#favicon');
          this.favIconData = o;
        }
      }
      window.customElements.define('time-tracker', TimeTracker);

      //Time Entry class
      class TimeEntry extends Base {
        constructor(data, parentNode) {
          data.templateId = 'time-entry';
          super();
          this.initData(data);
          this.initSelfDom(data.templateId, parentNode);
          this.initChildEntries(data.childEntries, this);
          this.addListeners();
          this.updateTimeText();
        }

        handleWhenActiveItself() {
          this.classList.add('is-active');
          this.querySelector('.start-stop').innerText = 'Stop';
        }

        addListeners() {
          super.addListeners(this);
          this.querySelector('.title')
            .addEventListener('blur', e => this.titleText = e.target.innerText);
          this.querySelector('.comment')
            .addEventListener('blur', e => this.commentText = e.target.innerText);
          this.querySelector('.is-own-time-billable input').addEventListener(
            'click', this.handleIsOwnTimeBillableClick.bind(this));
          this.querySelector('.start-stop')
            .addEventListener('click', this.handleStartStopClick.bind(this));
          this.querySelector('.generate-message')
            .addEventListener('click', this.generateMessageHandler.bind(this));
        }

        generateMessageArr(paddingLevel, useTotalNotOwnTime = false) {
          const pad = '  ';
          const commentLines = this.commentText ? this.commentText.split('\n') : [];
          const messageOwn = [
            `${pad.repeat(paddingLevel)}${getTime(this)} ${
                this.titleText.trimEnd()}`,
            ...commentLines.reduce((a, l) => {
              return a.push(`${pad.repeat(paddingLevel + 1)}${l.trimEnd()}`), a;
            }, []),
            `${pad.repeat(paddingLevel)}${'-'.repeat(10)}`,
          ];
          const childMessages = this.childEntries.reduce((a, e) => {
            //recursion is acceptable here, no huge trees are exptected
            return a.push(...e.generateMessageArr(paddingLevel + 1)), a;
          }, []);
          return [
            ...messageOwn,
            ...childMessages,
          ];

          function getTime(that) {
            const ts = useTotalNotOwnTime ? that.timeSpentTotal : that.timeSpentOwn;
            const m = Math.ceil(ts / 60000);
            const mRemainder = m % 60;
            const h = (m - mRemainder) / 60;
            return `${h}h ${mRemainder}m`;
          }
        }

        generateMessageHandler(e) {
          e.preventDefault();
          e.stopPropagation();
          const messageArr = this.generateMessageArr(0, true);
          removeLastDelimiter();
          const showMessageEvent = new CustomEvent('showmessage', {
            detail: { message: messageArr.join('\n'), },
            bubbles: true,
          });
          this.dispatchEvent(showMessageEvent);

          function removeLastDelimiter() {
            messageArr.pop();
          }
        }

        handleStartStopClick(e) {
          e.preventDefault();
          e.stopPropagation();
          if (this.activeChildOrSelf === this) {
            this.disactivate(this);
            const disactivateEvent = new CustomEvent('disactivate', {
              detail: { firedFrom: this, },
              bubbles: true,
            });
            this.dispatchEvent(disactivateEvent);
          } else {
            const entryActiveEvent = new CustomEvent('activate', {
              detail: { isBillable: this.isOwnTimeBillable, },
              bubbles: true,
            });
            this.dispatchEvent(entryActiveEvent);
          }
        }

        handleIsOwnTimeBillableClick(e) {
          e.stopPropagation();
          this.isOwnTimeBillable = !this.isOwnTimeBillable;
          const billableTimeChange = this.isOwnTimeBillable ?
            this.timeSpentOwn : -this.timeSpentOwn;
          const ev = new CustomEvent('is-billable-changed', {
            detail: {
              isBillable: this.isOwnTimeBillable,
              billableTimeChange,
            },
            bubbles: true,
          });
          this.dispatchEvent(ev);
        }

        updateTimeText() {
          this.querySelector('.total-value').innerText =
            this.convertTimeToText(this.timeSpentTotal);
          this.querySelector('.own-value > div').innerText =
            this.convertTimeToText(this.timeSpentOwn);
          this.querySelector('.billable-value').innerText =
            this.convertTimeToText(this.timeSpentBillable);
          const billablePercent = this.timeSpentTotal ?
            Math.floor(this.timeSpentBillable / this.timeSpentTotal * 100) :
            0;
          this.querySelector('.billable-percent').innerText = `${billablePercent}%`;
        }

        handleChildEntriesVisibility() {
          super.handleChildEntriesVisibility(this);
        }

        initData(data) {
          super.initData(data);
          this.isOwnTimeBillable = data?.isOwnTimeBillable || false;
          this.titleText = data?.titleText || 'SB-xxxx';
          this.commentText = data?.commentText || '';

          this.timeSpentOwn = data?.timeSpentOwn || 0;
          this.isOwnTimeBillable = data?.isOwnTimeBillable || false;
          this.classesToPreserve = data?.classesToPreserve || [];
        }

        initSelfDom(templateId) {
          const templateContent = document.querySelector(`#${templateId}`).content;
          const clone = templateContent.cloneNode(true);
          this.classesToPreserve.forEach((c) => this.classList.add(c));
          this.appendChild(clone);
          this.handleChildEntriesVisibility();
          this.querySelector('.title').innerText = this.titleText;
          this.querySelector('.comment').innerText = this.commentText;
          this.querySelector('.is-own-time-billable input').checked =
            this.isOwnTimeBillable;
        }

        addNewTimeEntry(e) {
          super.addNewTimeEntry(e, this);
        }
      }
      window.customElements.define('time-entry', TimeEntry);

      //MAIN
      let autoSaveInterval = 0;
      let tt = null;
      init();

      function init(jsonArg) {
        const version = [0, 0, 0];
        const versionStr = version.join('.');
        const storageEntryName = getStorageEntryName();
        const {restoreType, json} = getRestoreData();
        if (restoreType === 'fileImport') {
          attemptRestoreFromFileImport();
        } else if (restoreType === 'localStorage') {
          attemptRestoreFromLocalStorage();
        }
        setAutosave();

        function attemptRestoreFromLocalStorage() {
          if (isRunFirstTime()) {
            return createTimeTrackerFromScratch();
          }
          let data;
          try {
            data = JSON.parse(json);
          } catch(e) {
            const message = [
              `Failed to restore data from localStorage entry ${storageEntryName}`,
              'either it is corrupted or an unknown error has occurred',
              'Would you like to delete the entry and start a new time-tracker?',
            ].join('\n');
            if (window.confirm(message)) {
              window.localStorage.removeItem(storageEntryName);
              createTimeTrackerFromScratch();
            }
            return;
          }
          const {isAcceptable, versionToRestore} = checkVersion(data);
          if (isAcceptable) {
            data.version = version;
            tt = new TimeTracker(data);
            document.body.appendChild(tt);
          } else {
            const message = [
              `JSON from localStorage was generated in time-tracker.html`,
              `version ${versionToRestore}, but currently you're using`,
              `time-tracker.html version ${versionStr}, which may not work`,
              `correctly with the JSON file, which is being imported`,
              `Refusing to restore, try time-tracker.html`,
              `version ${versionToRestore}`,
              ``,
              `NOTE: Alternatively you can delete the localStorage entry`,
              `${storageEntryName} via the dev-tools <F12>, this will allow you`,
              `to use the current time-tracker.html version from scratch`,
            ].join('\n');;
            alert(message);
            return;
          }

          function createTimeTrackerFromScratch() {
            const data = Object.create(null);
            data.version = version;
            tt = new TimeTracker(data);
            document.body.appendChild(tt);
          }

          function isRunFirstTime() {
            return !json;
          }
        }

        function attemptRestoreFromFileImport() {
          let data;
          const brokenDataErrorMessage =
            `Failed to import JSON data, either the file is wrong or corrupted`;
          try {
            data = JSON.parse(json);
          } catch(e) {
            alert(brokenDataErrorMessage);
            return;
          }
          const {isAcceptable, versionToRestore} = checkVersion(data);
          if (isAcceptable) {
            tt.destroy();
            tt = new TimeTracker(data);
            document.body.appendChild(tt);
          } else if (versionToRestore === 'unknown') {
            alert(brokenDataErrorMessage);
          } else {
            alert([
              `Imported JSON file was generated in time-tracker.html`,
              `v${versionToRestore}, but currently you're using`,
              `time-tracker.html version ${versionStr}, which may not work`,
              `correctly with the JSON file, which is being imported`,
              `Refusing to import, try time-tracker.html version`,
              `${versionToRestore}`,
            ].join('\n'));
          }
        }

        function getRestoreData() {
          let restoreType = '';
          let json;
          if (jsonArg) {
            restoreType = 'fileImport';
            json = jsonArg;
          } else {
            restoreType = 'localStorage';
            json = localStorage.getItem(storageEntryName);
          }
          return {restoreType, json};
        }

        window.addEventListener('beforeunload', function() {
          if (tt) {
            localStorage.setItem(storageEntryName, tt);
          } else {
            this.localStorage.removeItem(storageEntryName);
          }
        });

        function setAutosave() {
          if (autoSaveInterval) {
            clearInterval(autoSaveInterval);
          }
          autoSaveInterval = setInterval(() => {
            localStorage.setItem(storageEntryName, tt);
          }, 300000);
        }

        function getStorageEntryName() {
          return location.href.replace(/^file:\/\//, '');
        }

        function checkVersion(data) {
          const majorVersionOfDataRestored = data?.version?.[0];
          const versionToRestore = Array.isArray(data?.version) ?
            data.version.join('.') : 'unknown';
          return {
            isAcceptable: version[0] === majorVersionOfDataRestored,
            versionToRestore,
          };
        }
      }
    })();
  </script>
</body>
</html>
